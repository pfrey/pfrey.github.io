<html>
 <head>
  <link rel="stylesheet" href="styles.css" type="text/css">
 </head>
 <body>
  <div class="container">
    <div class="sidebar">
      <h1>Hamtramck Neighborhood Map</h1>
      <div>
        <input id="show-listings" type="button" value="Show Listings">
        <input id="hide-listings" type="button" value="Hide Listings">

        <!-- Search Input -->
        <input class="search" data-bind="textInput: searchOption, valueUpdate: 'afterkeydown'" placeholder="Search Locations...">
        <hr class="sidebar_hr">
        <ul class="nav flex-column" data-bind="foreach: myLocationsFilter">
          <a href="#"><li class="nav-item text-white location_list" data-bind="text: title, click: $parent.populateAndBounceMarker"></li></a>
        </ul>
        <img class="foursquare" src="img/foursquare_attr.png" srcset="img/foursquare_attr@2x.png" alt="Powered By Foursquare!">
      </div>

    <div id="map"></div>
  </div>
  <script>
    var map;
    var markers = [];
    /**
    * return a valid URL to static map image
    */
    function getStaticMap(key, props) {
      const markers = (props.markers || []).map(marker => 
        [
            `&markers=color:${marker.color || 'red'}`,
            `label:${(marker.label || '').replace('|', '\\|')}`,
            `${marker.lat},${marker.lng}`
        ].join('|')
      );
      return `https://maps.googleapis.com/maps/api/staticmap?center=${props.lat},${props.lng}&zoom=13&size=${props.width}x${props.height}&maptype=${props.type || 'roadmap'}${markers.join('')}&key=${key}`;
    }

    const data = {
      lat: 42.3528165,
      lng: -83.1692446,
      height: 500,
      width: 500,
      markers: [{
        lat: 40.78,
        lng: -73,
      label: 'X',
      color: 'yellow'
      }]
    }

    const mapURL = getStaticMap(AIzaSyBNiVrOQqLRb6SuJgjBRM_bQV2hYAs-hRw, data);


    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 42.3528165, lng: -83.1692446},
        zoom: 10
      });

      var locations = [
        {title: 'Better Life Bags', location: {lat: 42.3944756, lng: -83.0587978}},
        {title: 'The Henry Ford Museum', location: {lat: 42.3032775, lng: -83.2361526}},
        {title: 'Hamtramck Disneyland', location: {lat: 42.407161, lng: -83.058643}},
        {title: 'Detroit Zoo', location: {lat: 42.4768224, lng: -83.1499949}},
        {title: 'Eastern Market', location: {lat: 42.3494867, lng: -83.0494247}},
        {title: 'Belle Isle Aquarium', location: {lat: 42.3365144, lng: -82.9852751}}
      ];

      var largeInfoWindow = new google.maps.InfoWindow();
      for (var i = 0; i < locations.length; i++) {
        var position = locations[i].location;
        var title = locations[i].title;
        var marker = new google.maps.Marker({
          map: map,
          position: position,
          title: title,
          animation: google.maps.Animation.DROP,
          id: i
        });
        markers.push(marker);
        marker.addListener('click', function() {
          populateInfoWindow(this, largeInfoWindow);
        });
      }
      document.getElementById('show-listings').addEventListener('click', showListings);
      document.getElementById('hide-listings').addEventListener('click', hideListings);
    }
    function populateInfoWindow(marker, infoWindow) {
      if (infoWindow.marker != marker) {
        infoWindow.marker = marker;
        infoWindow.setContent('<div>' + marker.title + '</div>');
        infoWindow.open(map, marker);
        infoWindow.addListener('closeclick', function() {
          infoWindow.setMarker(null);
        });
      }
    }
    
    function showListings() {
      var bounds = new google.maps.LatLngBounds();
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(map);
        bounds.extend(markers[i].position);
      }
      map.fitBounds(bounds);
    }
    function hideListings() {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
      }
    }
    var AppViewModel = function() {
    var self = this;
  
    this.searchText = ko.observable('');
    this.locationsList = ko.observableArray();
  
    map = new google.maps.Map(document.getElementById('mapDiv'), {
      center: { lat: 59.942803, lng: 30.324841 },
      zoom: 14
    });
  
    initData.forEach(function(datum) {
      var location = new Location(datum);
      self.locationsList.push(location);
    });
  
    this.myLocationsFilter = ko.computed(function() {
      return this.locationsList().filter(function(location) {
        var isMatched = location.searchTitle.indexOf(this.searchText().toLowerCase()) !== -1;
        location.marker.setVisible(isMatched);
  
        return isMatched;
      }, this);
    }, this);
  };
  
  function init() {
    ko.applyBindings(new AppViewModel());
  }
   </script>

  <!--Load the GoogleMaps JS API ASYNCHRONOUSLY-->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNiVrOQqLRb6SuJgjBRM_bQV2hYAs-hRw&callback=initMap"></script>

  <script src="js/markers.js" charset="utf-8"></script>
  <script src="js/styles.js" charset="utf-8"></script>
  <script src="js/app.js" charset="utf-8"></script>
  <script src="js/manipulation.js" charset="utf-8"></script>

 </body>
</html>
